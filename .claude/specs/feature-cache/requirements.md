# 离线缓存功能需求文档

## 介绍

离线缓存功能旨在为 Prompt Vault (pv) 添加本地缓存机制，使用户能够在网络不稳定或离线环境下继续使用已缓存的提示词。该功能将通过本地缓存目录存储索引和提示词内容，并提供同步命令以及现有命令的离线支持选项。

## 与产品愿景的对齐

该功能直接支持产品愿景中的关键目标：
- **离线支持**：实现 product.md 中明确提到的"本地缓存支持离线访问和使用"
- **跨平台同步**：增强设备间数据同步的可靠性，即使在网络不稳定时也能工作
- **数据可用性**：确保用户在任何环境下都能访问重要的提示词数据

## 需求

### 需求 1：本地缓存目录管理

**用户故事：** 作为开发者，我希望系统能自动管理本地缓存目录，以便存储索引和提示词内容。

#### 验收标准

1. WHEN 系统首次运行 THEN 系统 SHALL 在用户缓存目录下创建 `~/.cache/pv/` 目录
2. WHEN 缓存目录不存在 THEN 系统 SHALL 自动创建所需的子目录结构（`prompts/`）
3. WHEN 缓存目录权限不正确 THEN 系统 SHALL 设置正确的文件权限（0700）
4. IF 用户环境变量 `PV_CACHE_DIR` 被设置 THEN 系统 SHALL 使用该路径作为缓存根目录

### 需求 2：远程优先的缓存策略

**用户故事：** 作为用户，我希望系统优先使用最新的远程数据，同时在网络不可用时回退到本地缓存。

#### 验收标准

1. WHEN 执行任何数据读取操作 THEN 系统 SHALL 首先尝试从 GitHub Gist 获取最新数据
2. IF 远程数据获取成功 THEN 系统 SHALL 更新本地缓存并返回远程数据
3. IF 远程数据获取失败 AND 本地缓存存在 THEN 系统 SHALL 从本地缓存读取数据
4. IF 远程数据获取失败 AND 本地缓存不存在 THEN 系统 SHALL 返回相应的错误信息

### 需求 3：sync 命令实现

**用户故事：** 作为用户，我希望有一个专门的同步命令，以便手动将远程 GitHub Gist 数据同步到本地缓存。

#### 验收标准

1. WHEN 执行 `pv sync` 命令 THEN 系统 SHALL 从 GitHub Gist 下载最新的索引数据
2. WHEN 索引同步成功 THEN 系统 SHALL 下载所有提示词的内容到本地缓存
3. WHEN 同步过程中遇到单个提示词失败 THEN 系统 SHALL 记录错误但继续处理其他提示词
4. WHEN 同步完成 THEN 系统 SHALL 显示同步统计信息（成功/失败/跳过的提示词数量）
5. IF 认证失败 THEN 系统 SHALL 提示用户重新登录

### 需求 4：get 命令的离线增强

**用户故事：** 作为用户，我希望 get 命令能在网络不稳定时自动使用缓存数据，确保操作的连续性。

#### 验收标准

1. WHEN 执行 `pv get` 命令 THEN 系统 SHALL 首先尝试执行一次快速同步
2. IF 快速同步成功 THEN 系统 SHALL 使用最新的远程数据执行 get 操作
3. IF 快速同步失败 THEN 系统 SHALL 显示警告信息并从本地缓存执行 get 操作
4. WHEN 从缓存读取数据 THEN 系统 SHALL 在输出中标明数据来源为本地缓存
5. IF 本地缓存中不存在请求的提示词 THEN 系统 SHALL 返回明确的错误信息

### 需求 5：list 命令的 --remote 选项

**用户故事：** 作为用户，我希望 list 命令默认使用本地缓存以提高性能，同时提供选项强制从远程获取最新数据。

#### 验收标准

1. WHEN 执行 `pv list` 命令（无参数）THEN 系统 SHALL 从本地缓存读取并显示提示词列表
2. WHEN 执行 `pv list --remote` 命令 THEN 系统 SHALL 直接从 GitHub Gist 获取最新数据
3. WHEN 使用 `--remote` 选项且获取成功 THEN 系统 SHALL 更新本地缓存
4. IF 本地缓存不存在且未使用 `--remote` 选项 THEN 系统 SHALL 提示用户先执行 `pv sync` 命令
5. WHEN 显示缓存数据 THEN 系统 SHALL 在输出底部显示缓存的最后更新时间

## 非功能性需求

### 性能要求
- 本地缓存读取操作应在 100ms 内完成
- sync 命令应提供清晰的进度指示（当前/总数）
- 缓存文件使用简单的 JSON 格式便于调试和维护

### 安全要求
- 缓存目录权限应设置为仅用户可访问（0700）
- 缓存的提示词内容不应包含敏感的认证信息
- 缓存文件应支持基本的完整性检查

### 可靠性要求
- 缓存损坏时系统应能自动重建缓存
- 系统应优雅处理磁盘空间不足的情况
- 同步失败时应保留原有缓存数据

### 可用性要求
- 缓存操作应提供清晰的进度指示
- 错误信息应包含具体的问题诊断和解决建议
- 命令应提供 `--verbose` 选项以显示详细的缓存操作信息