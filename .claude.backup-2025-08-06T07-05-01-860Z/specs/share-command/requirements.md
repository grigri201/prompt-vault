# Share 命令需求规范

## 功能概述
Share 命令使用户能够将私有 GitHub Gists 转换为公开 Gists，让提示词可以与他人分享。此功能包括数据结构修改以支持父子关系和导出跟踪。

## 用户故事

### US1: 交互式分享选择
**作为** 提示词管理员  
**我希望** 不带参数运行 `pv share`  
**以便** 我可以看到所有私有提示词并交互式选择要分享的内容

**验收标准:**
- 当我执行 `pv share` 不带参数时
- 系统显示所有私有提示词的 TUI 列表（类似 `pv delete`）
- 并且我可以使用方向键导航，用回车键选择
- 并且系统验证我的选择并启动分享流程

### US2: 关键字过滤分享
**作为** 提示词管理员  
**我希望** 运行 `pv share <keyword>` 
**以便** 我可以快速查找和分享匹配特定条件的提示词

**验收标准:**
- 当我执行 `pv share <keyword>` 时
- 系统按名称、作者或描述包含关键字来过滤提示词
- 并在 TUI 选择界面中显示过滤结果
- 并支持部分匹配和中文关键字
- 并且我可以从过滤结果中选择要分享的内容

### US3: 直接 URL 分享
**作为** 提示词管理员  
**我希望** 运行 `pv share <gist_url>`
**以便** 我可以通过其 GitHub Gist URL 直接分享特定提示词

**验收标准:**
- 当我用有效的私有 gist URL 执行 `pv share <gist_url>` 时
- 系统验证该 gist 是私有的且我有访问权限
- 并直接启动分享流程而不显示选择界面
- 当该 gist 已经是公开的时
- 系统显示"不需要 share public gist"并退出
- 当我没有访问该 gist 的权限时
- 系统显示访问错误并退出

### US4: 分享流程执行
**作为** 提示词管理员  
**我希望** 系统自动处理分享工作流
**以便** 我的私有 gist 变得可以公开访问

**验收标准:**
- 当选择一个提示词进行分享时
- 系统检查 gist_url 是否已经存在于 index.exports 中
- 如果存在，则更新现有的公开 gist
- 如果不存在，则创建新的公开 gist
- 并且所有导出的提示词 gist 必须是公开的
- 并且新建/更新的 gist 被添加到 index.exports 数组中

### US5: 增强的 Add 命令 URL 支持
**作为** 提示词管理员  
**我希望** 使用公开 gist URL 运行 `pv add <gist_url>`
**以便** 我可以将现有的公开提示词导入到我的集合中

**验收标准:**
- 当我用公开 gist URL 执行 `pv add <gist_url>` 时
- 系统验证该 gist_url 是公开 gist
- 并验证它是有效的提示词 gist 格式
- 并将提示词添加到本地索引中
- 当 gist 是私有的或格式无效时
- 系统显示相应的错误消息并退出

## 技术需求

### 数据结构修改

#### TR1: Prompt 模型增强
- 必须在 Prompt 模型中添加可选的 `Parent *string` 字段
- Parent 字段存储原始私有提示词的 gist URL
- 对于原始提示词 Parent 字段为 nil，对于分享副本则填充该字段

#### TR2: Index 模型增强  
- 必须在 Index 模型中添加 `Exports []Prompt` 字段
- Exports 数组存储所有已公开分享的提示词
- 维护私有原件和公开副本之间的关系

### 命令行为需求

#### TR3: Share 命令模式
- 必须支持三种执行模式：交互式、关键字筛选、直接 URL
- 必须使用类似删除命令的现有 TUI 组件
- 必须在分享前验证用户权限

#### TR4: Gist 管理
- 必须为所有分享的提示词创建公开 gist
- 必须更新现有导出而不是创建重复项
- 必须在元数据中维护父子关系

#### TR5: Add 命令增强
- 必须支持 gist URL 参数和文件参数  
- 必须验证 gist URL 的公开可访问性
- 必须解析和验证来自 gist 内容的提示词格式

## 业务规则

### BR1: 访问控制
- 用户只能分享他们拥有或有写入权限的 gist
- 系统必须在继续之前验证 GitHub 权限
- 公开 gist 不能被"分享"（已经是公开的）

### BR2: 导出管理
- 每个私有 gist 最多只能有一个公开导出
- 后续分享会更新现有导出而不是创建新的
- 导出跟踪防止重复的公开 gist

### BR3: 数据完整性
- 必须在操作过程中维护父子关系
- 在分享操作期间必须保持索引一致性
- 必须验证 Gist URL 的格式和可访问性

## 非功能性需求

### NFR1: 性能
- 分享操作应在正常大小提示词的 10 秒内完成
- TUI 交互必须响应迅速（<100ms 响应时间）

### NFR2: 可靠性  
- 系统必须优雅地处理 GitHub API 失败
- 分享过程中的部分失败不得损坏索引
- 所有操作必须尽可能原子化

### NFR3: 可用性
- 错误消息必须清晰且可操作，使用中文
- TUI 界面应匹配现有命令模式
- 命令帮助文本必须全面

## 约束条件

### C1: GitHub API 限制
- 必须遵守 gist 操作的 GitHub 速率限制
- 必须优雅地处理认证令牌过期

### C2: 向后兼容性
- 现有提示词数据在模型更改后必须保持完整
- 现有命令必须继续工作而无需修改

### C3: CLI 一致性
- 新命令必须遵循现有 CLI 模式和约定
- 错误处理必须与其他命令保持一致

## 完成定义

- [ ] Share 命令支持所有三种执行模式
- [ ] 数据结构修改以支持父子关系和导出
- [ ] Add 命令增强以支持 gist URL 导入  
- [ ] 通过测试验证所有验收标准
- [ ] 错误处理覆盖所有指定的边缘情况
- [ ] 文档更新以反映新功能
- [ ] 验证与现有 TUI 组件的集成
- [ ] 使用各种 gist 状态测试 GitHub API 集成